| function_sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -- Function: _order_lock
CREATE OR REPLACE FUNCTION public._order_lock(p_order_id uuid)
 RETURNS void
 LANGUAGE sql
AS $function$
  select pg_advisory_xact_lock(hashtext(p_order_id::text));
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- Function: add_bom_component
CREATE OR REPLACE FUNCTION public.add_bom_component(p_bom_id uuid, p_component_id uuid, p_quantity_required numeric, p_unit text DEFAULT 'each'::text, p_is_optional boolean DEFAULT false, p_notes text DEFAULT NULL::text)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_item_id uuid;
BEGIN
  INSERT INTO public.bom_items (bom_id, component_id, quantity_required, unit, is_optional, notes)
  VALUES (p_bom_id, p_component_id, p_quantity_required, p_unit, p_is_optional, p_notes)
  ON CONFLICT (bom_id, component_id) 
  DO UPDATE SET 
    quantity_required = p_quantity_required,
    unit = p_unit,
    is_optional = p_is_optional,
    notes = p_notes
  RETURNING id INTO v_item_id;
  
  RETURN v_item_id;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- Function: add_participant
CREATE OR REPLACE FUNCTION public.add_participant(p_conversation_id uuid, p_user_id uuid)
 RETURNS boolean
 LANGUAGE sql
 SECURITY DEFINER
AS $function$
  insert into public.conversation_participants(conversation_id, user_id)
  values (p_conversation_id, p_user_id)
  on conflict do nothing;
  select true;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- Function: add_participant
CREATE OR REPLACE FUNCTION public.add_participant(p_conversation_id text, p_user_id text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  INSERT INTO public.conversation_participants (conversation_id, user_id)
  VALUES (p_conversation_id::uuid, p_user_id::uuid)
  ON CONFLICT (conversation_id, user_id) DO NOTHING;
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- Function: add_product_requirement
CREATE OR REPLACE FUNCTION public.add_product_requirement(p_shopify_product_id text, p_shopify_variant_id text, p_product_title text, p_component_id uuid, p_quantity_per_unit numeric, p_is_optional boolean DEFAULT false, p_auto_deduct boolean DEFAULT true)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_req_id uuid;
BEGIN
  INSERT INTO public.product_requirements (
    shopify_product_id, shopify_variant_id, product_title, 
    component_id, quantity_per_unit, is_optional, auto_deduct
  )
  VALUES (
    p_shopify_product_id, p_shopify_variant_id, p_product_title,
    p_component_id, p_quantity_per_unit, p_is_optional, p_auto_deduct
  )
  RETURNING id INTO v_req_id;
  
  RETURN v_req_id;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- Function: admin_delete_order
CREATE OR REPLACE FUNCTION public.admin_delete_order(p_order_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
begin
  delete from stage_events  where order_id = p_order_id;
  delete from work_queue    where order_id = p_order_id;
  delete from order_photos  where order_id = p_order_id;
  delete from audit_log     where order_id = p_order_id;
  delete from dead_letter   where payload->>'order_id' = p_order_id::text;
  delete from orders        where id = p_order_id;
end; $function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- Function: alpha_suffix
CREATE OR REPLACE FUNCTION public.alpha_suffix(p_idx integer)
 RETURNS text
 LANGUAGE plpgsql
 IMMUTABLE
AS $function$
declare
  n int := p_idx;
  s text := '';
  r int;
begin
  if n < 0 then
    return 'A';
  end if;
  loop
    r := n % 26;
    s := chr(65 + r) || s;   -- 65 = 'A'
    n := (n / 26) - 1;       -- 0-based to Excel-like
    exit when n < 0;
  end loop;
  return s;
end;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- Function: app_can_access_store
CREATE OR REPLACE FUNCTION public.app_can_access_store(s text)
 RETURNS boolean
 LANGUAGE sql
 STABLE
AS $function$
select
  app_role() = 'Admin'
  or exists (
    select 1
    from users u
    where u.email = auth_email()
      and (u.store_access @> array[s]::text[])
  );
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- Function: app_is_service_role
CREATE OR REPLACE FUNCTION public.app_is_service_role()
 RETURNS boolean
 LANGUAGE sql
 STABLE
AS $function$
select coalesce((current_setting('request.jwt.claims', true)::jsonb ->> 'role'), '') = 'service_role';
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- Function: app_role
CREATE OR REPLACE FUNCTION public.app_role()
 RETURNS text
 LANGUAGE sql
 STABLE
AS $function$
select coalesce( (select role from users where email = auth_email() limit 1), 'Staff');
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- Function: assign_staff
CREATE OR REPLACE FUNCTION public.assign_staff(p_order_id text, p_store text, p_staff_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_table_name text;
BEGIN
  v_table_name := 'orders_' || p_store;
  
  EXECUTE format('UPDATE public.%I SET assignee_id = $1, updated_at = now() WHERE id = $2', v_table_name)
  USING p_staff_id, p_order_id;
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- Function: assign_staff_to_order
CREATE OR REPLACE FUNCTION public.assign_staff_to_order(p_order_id uuid, p_staff_id uuid)
 RETURNS orders
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_before public.stage;
  v_after  public.stage;
  v_row    public.orders;
begin
  perform public._order_lock(p_order_id);

  select stage into v_before from public.orders where id = p_order_id for update;
  if not found then raise exception 'ORDER_NOT_FOUND'; end if;

  update public.orders
     set assignee_id = p_staff_id,
         stage = case
                   when stage = 'Covering_pending' then 'Covering_in_progress'
                   when stage = 'Decorating_pending' then 'Decorating_in_progress'
                   else stage
                 end,
         updated_at = now()
   where id = p_order_id
  returning * into v_row;

  v_after := v_row.stage;
  if v_after is distinct from v_before then
    insert into public.stage_events(order_id, from_stage, to_stage, performed_by, reason)
    values (p_order_id, v_before, v_after, null, 'assign_staff');
  end if;

  insert into public.audit_log(action, performed_by, source, meta)
  values ('assign_staff_to_order', null, 'rpc', jsonb_build_object('order_id', p_order_id, 'staff_id', p_staff_id));

  return v_row;
end
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- Function: auth_email
CREATE OR REPLACE FUNCTION public.auth_email()
 RETURNS text
 LANGUAGE sql
 STABLE
AS $function$
select coalesce( (current_setting('request.jwt.claims', true)::jsonb ->> 'email'), '' );
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- Function: complete_covering
CREATE OR REPLACE FUNCTION public.complete_covering(p_order_id uuid)
 RETURNS orders
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_before public.stage;
  v_after  public.stage;
  v_row    public.orders;
begin
  perform public._order_lock(p_order_id);

  select stage into v_before from public.orders where id = p_order_id for update;
  if not found then raise exception 'ORDER_NOT_FOUND'; end if;

  update public.orders
     set covering_complete_ts = coalesce(covering_complete_ts, now()),
         stage = case when v_before = 'Covering_in_progress' then 'Decorating_pending' else stage end,
         updated_at = now()
   where id = p_order_id
  returning * into v_row;

  v_after := v_row.stage;
  if v_after is distinct from v_before then
    insert into public.stage_events(order_id, from_stage, to_stage, performed_by, reason)
    values (p_order_id, v_before, v_after, null, 'complete_covering');
  end if;

  insert into public.audit_log(action, performed_by, source, meta)
  values ('complete_covering', null, 'rpc', jsonb_build_object('order_id', p_order_id));

  return v_row;
end
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- Function: complete_covering
CREATE OR REPLACE FUNCTION public.complete_covering(p_order_id text, p_store text, p_notes text DEFAULT NULL::text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_table_name text;
  v_user_id uuid;
BEGIN
  v_table_name := 'orders_' || p_store;
  v_user_id := COALESCE(auth.uid(), '00000000-0000-0000-0000-000000000000'::uuid);
  
  EXECUTE format('UPDATE public.%I SET stage = ''Decorating'', covering_complete_ts = now(), updated_at = now() WHERE id = $1', v_table_name)
  USING p_order_id;
  
  INSERT INTO public.stage_events (order_id, store, stage, event, performed_by, notes)
  VALUES (p_order_id, p_store, 'Covering', 'completed', v_user_id, p_notes);
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- Function: complete_decorating
CREATE OR REPLACE FUNCTION public.complete_decorating(p_order_id uuid)
 RETURNS orders
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_before public.stage;
  v_after  public.stage;
  v_row    public.orders;
begin
  perform public._order_lock(p_order_id);

  select stage into v_before from public.orders where id = p_order_id for update;
  if not found then raise exception 'ORDER_NOT_FOUND'; end if;

  update public.orders
     set decorating_complete_ts = coalesce(decorating_complete_ts, now()),
         stage = case when v_before = 'Decorating_in_progress' then 'Packing_in_progress' else stage end,
         updated_at = now()
   where id = p_order_id
  returning * into v_row;

  v_after := v_row.stage;
  if v_after is distinct from v_before then
    insert into public.stage_events(order_id, from_stage, to_stage, performed_by, reason)
    values (p_order_id, v_before, v_after, null, 'complete_decorating');
  end if;

  insert into public.audit_log(action, performed_by, source, meta)
  values ('complete_decorating', null, 'rpc', jsonb_build_object('order_id', p_order_id));

  return v_row;
end
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- Function: complete_decorating
CREATE OR REPLACE FUNCTION public.complete_decorating(p_order_id text, p_store text, p_notes text DEFAULT NULL::text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_table_name text;
  v_user_id uuid;
BEGIN
  v_table_name := 'orders_' || p_store;
  v_user_id := COALESCE(auth.uid(), '00000000-0000-0000-0000-000000000000'::uuid);
  
  EXECUTE format('UPDATE public.%I SET stage = ''Packing'', decorating_complete_ts = now(), packing_start_ts = now(), updated_at = now() WHERE id = $1', v_table_name)
  USING p_order_id;
  
  INSERT INTO public.stage_events (order_id, store, stage, event, performed_by, notes)
  VALUES (p_order_id, p_store, 'Decorating', 'completed', v_user_id, p_notes);
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- Function: complete_filling
CREATE OR REPLACE FUNCTION public.complete_filling(p_order_id uuid)
 RETURNS orders
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_before public.stage;
  v_after  public.stage;
  v_row    public.orders;
begin
  perform public._order_lock(p_order_id);

  select stage into v_before from public.orders where id = p_order_id for update;
  if not found then raise exception 'ORDER_NOT_FOUND'; end if;

  update public.orders
     set filling_complete_ts = coalesce(filling_complete_ts, now()),
         stage = case when v_before = 'Filling_in_progress' then 'Covering_pending' else stage end,
         updated_at = now()
   where id = p_order_id
  returning * into v_row;

  v_after := v_row.stage;
  if v_after is distinct from v_before then
    insert into public.stage_events(order_id, from_stage, to_stage, performed_by, reason)
    values (p_order_id, v_before, v_after, null, 'complete_filling');
  end if;

  insert into public.audit_log(action, performed_by, source, meta)
  values ('complete_filling', null, 'rpc', jsonb_build_object('order_id', p_order_id));

  return v_row;
end
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- Function: complete_filling
CREATE OR REPLACE FUNCTION public.complete_filling(p_order_id text, p_store text, p_notes text DEFAULT NULL::text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_table_name text;
  v_current_stage stage_type;
  v_user_id uuid;
BEGIN
  v_table_name := 'orders_' || p_store;
  v_user_id := COALESCE(auth.uid(), '00000000-0000-0000-0000-000000000000'::uuid);
  
  EXECUTE format('SELECT stage FROM public.%I WHERE id = $1', v_table_name)
  INTO v_current_stage
  USING p_order_id;
  
  IF v_current_stage IS NULL THEN
    RAISE EXCEPTION 'Order not found: %', p_order_id;
  END IF;
  
  IF v_current_stage != 'Filling' THEN
    RAISE EXCEPTION 'Order must be in Filling stage to complete filling';
  END IF;
  
  EXECUTE format('UPDATE public.%I SET stage = ''Covering'', filling_complete_ts = now(), updated_at = now() WHERE id = $1', v_table_name)
  USING p_order_id;
  
  INSERT INTO public.stage_events (order_id, store, stage, event, performed_by, notes)
  VALUES (p_order_id, p_store, 'Filling', 'completed', v_user_id, p_notes);
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- Function: complete_packing
CREATE OR REPLACE FUNCTION public.complete_packing(p_order_id uuid)
 RETURNS orders
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_before public.stage;
  v_row    public.orders;
begin
  perform public._order_lock(p_order_id);

  select stage into v_before from public.orders where id = p_order_id for update;
  if not found then raise exception 'ORDER_NOT_FOUND'; end if;

  update public.orders
     set packing_complete_ts = coalesce(packing_complete_ts, now()),
         stage = 'Complete',
         updated_at = now()
   where id = p_order_id
  returning * into v_row;

  if v_before is distinct from 'Complete' then
    insert into public.stage_events(order_id, from_stage, to_stage, performed_by, reason)
    values (p_order_id, v_before, 'Complete', null, 'complete_packing');
  end if;

  insert into public.audit_log(action, performed_by, source, meta)
  values ('complete_packing', null, 'rpc', jsonb_build_object('order_id', p_order_id));

  return v_row;
end
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- Function: complete_packing
CREATE OR REPLACE FUNCTION public.complete_packing(p_order_id text, p_store text, p_notes text DEFAULT NULL::text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_table_name text;
  v_user_id uuid;
BEGIN
  v_table_name := 'orders_' || p_store;
  v_user_id := COALESCE(auth.uid(), '00000000-0000-0000-0000-000000000000'::uuid);
  
  EXECUTE format('UPDATE public.%I SET stage = ''Complete'', packing_complete_ts = now(), updated_at = now() WHERE id = $1', v_table_name)
  USING p_order_id;
  
  INSERT INTO public.stage_events (order_id, store, stage, event, performed_by, notes)
  VALUES (p_order_id, p_store, 'Packing', 'completed', v_user_id, p_notes);
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- Function: create_conversation
CREATE OR REPLACE FUNCTION public.create_conversation(p_participants uuid[], p_name text DEFAULT NULL::text, p_type text DEFAULT 'direct'::text)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare
  v_convo_id uuid;
  v_me uuid := auth.uid();
  v_name text := p_name;
begin
  if v_me is null then
    raise exception 'Not authenticated';
  end if;

  if p_type not in ('direct','group','broadcast') then
    raise exception 'Invalid conversation type %', p_type;
  end if;

  if array_length(p_participants,1) is null or array_length(p_participants,1) = 0 then
    raise exception 'At least one participant required';
  end if;

  -- for direct, normalize name empty (UI can show other user's name)
  if p_type = 'direct' and v_name is null then
    v_name := null;
  end if;

  insert into public.conversations(type, name, created_by)
  values (p_type, v_name, v_me)
  returning id into v_convo_id;

  -- add creator
  insert into public.conversation_participants(conversation_id, user_id, role)
  values (v_convo_id, v_me, 'owner')
  on conflict do nothing;

  -- add other participants
  insert into public.conversation_participants(conversation_id, user_id)
  select v_convo_id, unnest(p_participants)
  on conflict do nothing;

  -- initialize read marker for creator
  insert into public.message_reads(conversation_id, user_id, last_read_at)
  values (v_convo_id, v_me, now())
  on conflict (conversation_id, user_id) do update set last_read_at = excluded.last_read_at;

  return v_convo_id;
end;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- Function: create_conversation_text
CREATE OR REPLACE FUNCTION public.create_conversation_text(p_participants text[], p_name text DEFAULT NULL::text, p_type text DEFAULT 'direct'::text)
 RETURNS uuid
 LANGUAGE sql
 SECURITY DEFINER
AS $function$
  select public.create_conversation(
    array(select x::uuid from unnest(p_participants) as x),
    p_name,
    p_type
  );
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- Function: current_user_name
CREATE OR REPLACE FUNCTION public.current_user_name()
 RETURNS text
 LANGUAGE sql
 STABLE
AS $function$
  select coalesce(
    (auth.jwt() -> 'user_metadata' ->> 'full_name'),
    (auth.jwt() ->> 'email'),
    'Unknown'
  );
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- Function: deduct_inventory_for_order
CREATE OR REPLACE FUNCTION public.deduct_inventory_for_order(p_order_id text, p_product_title text, p_store text, p_quantity integer DEFAULT 1)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_user_id uuid;
  v_bom_id uuid;
  v_deducted_count integer := 0;
  v_item record;
  v_insufficient_stock text[];
BEGIN
  v_user_id := COALESCE(auth.uid(), '00000000-0000-0000-0000-000000000000'::uuid);
  
  -- Find matching BOM
  SELECT id INTO v_bom_id
  FROM public.boms
  WHERE product_title = p_product_title
    AND (store = p_store OR store = 'both')
    AND is_active = true
  LIMIT 1;
  
  IF v_bom_id IS NULL THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'No BOM found for product: ' || p_product_title
    );
  END IF;
  
  -- Check if we have enough stock for all components
  FOR v_item IN
    SELECT bi.component_id, bi.quantity_required, c.name, c.current_stock, bi.is_optional
    FROM public.bom_items bi
    JOIN public.components c ON bi.component_id = c.id
    WHERE bi.bom_id = v_bom_id
  LOOP
    IF NOT v_item.is_optional AND v_item.current_stock < (v_item.quantity_required * p_quantity) THEN
      v_insufficient_stock := array_append(v_insufficient_stock, v_item.name);
    END IF;
  END LOOP;
  
  -- If insufficient stock, return error
  IF array_length(v_insufficient_stock, 1) > 0 THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'Insufficient stock',
      'components', v_insufficient_stock
    );
  END IF;
  
  -- Deduct stock for each component
  FOR v_item IN
    SELECT bi.component_id, bi.quantity_required, c.current_stock
    FROM public.bom_items bi
    JOIN public.components c ON bi.component_id = c.id
    WHERE bi.bom_id = v_bom_id
      AND bi.is_optional = false
  LOOP
    -- Update stock
    UPDATE public.components
    SET current_stock = current_stock - (v_item.quantity_required * p_quantity),
        updated_at = now()
    WHERE id = v_item.component_id;
    
    -- Log transaction
    INSERT INTO public.stock_transactions (
      component_id, transaction_type, quantity_change,
      quantity_before, quantity_after, reference_order_id,
      reason, performed_by
    )
    VALUES (
      v_item.component_id,
      'order_deduction',
      -(v_item.quantity_required * p_quantity),
      v_item.current_stock,
      v_item.current_stock - (v_item.quantity_required * p_quantity),
      p_order_id,
      'Deducted for order completion',
      v_user_id
    );
    
    v_deducted_count := v_deducted_count + 1;
  END LOOP;
  
  RETURN jsonb_build_object(
    'success', true,
    'order_id', p_order_id,
    'components_deducted', v_deducted_count
  );
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- Function: delete_accessory_keyword
CREATE OR REPLACE FUNCTION public.delete_accessory_keyword(p_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  DELETE FROM public.accessory_keywords WHERE id = p_id;
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- Function: feature_rls_enabled
CREATE OR REPLACE FUNCTION public.feature_rls_enabled()
 RETURNS boolean
 LANGUAGE sql
 STABLE
AS $function$
select coalesce(
  (select (value->>'enabled')::boolean from settings where store = 'global' and key = 'rls' limit 1),
  false
);
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- Function: find_component_by_keyword
CREATE OR REPLACE FUNCTION public.find_component_by_keyword(p_keyword text)
 RETURNS TABLE(component_id uuid, component_name text, component_sku text, current_stock numeric, keyword_matched text, match_type text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    c.id as component_id,
    c.name as component_name,
    c.sku as component_sku,
    c.current_stock,
    ak.keyword as keyword_matched,
    ak.match_type
  FROM public.accessory_keywords ak
  JOIN public.components c ON ak.component_id = c.id
  WHERE ak.is_active = true
    AND c.is_active = true
    AND (
      (ak.match_type = 'exact' AND LOWER(ak.keyword) = LOWER(p_keyword)) OR
      (ak.match_type = 'contains' AND LOWER(p_keyword) LIKE '%' || LOWER(ak.keyword) || '%') OR
      (ak.match_type = 'starts_with' AND LOWER(p_keyword) LIKE LOWER(ak.keyword) || '%')
    )
  ORDER BY ak.priority DESC, LENGTH(ak.keyword) DESC
  LIMIT 1;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- Function: get_accessory_keywords
CREATE OR REPLACE FUNCTION public.get_accessory_keywords(p_search text DEFAULT NULL::text, p_is_active boolean DEFAULT true)
 RETURNS TABLE(id uuid, keyword text, component_id uuid, component_name text, component_sku text, priority integer, match_type text, is_active boolean, created_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    ak.id,
    ak.keyword,
    ak.component_id,
    c.name as component_name,
    c.sku as component_sku,
    ak.priority,
    ak.match_type,
    ak.is_active,
    ak.created_at
  FROM public.accessory_keywords ak
  JOIN public.components c ON ak.component_id = c.id
  WHERE (p_is_active IS NULL OR ak.is_active = p_is_active)
    AND (p_search IS NULL OR 
         ak.keyword ILIKE '%' || p_search || '%' OR 
         c.name ILIKE '%' || p_search || '%')
  ORDER BY ak.priority DESC, ak.keyword;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- Function: get_bom_details
CREATE OR REPLACE FUNCTION public.get_bom_details(p_bom_id uuid)
 RETURNS TABLE(bom_id uuid, product_title text, store text, description text, component_id uuid, component_sku text, component_name text, quantity_required numeric, unit text, current_stock numeric, is_optional boolean, notes text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    b.id as bom_id,
    b.product_title,
    b.store,
    b.description,
    c.id as component_id,
    c.sku as component_sku,
    c.name as component_name,
    bi.quantity_required,
    bi.unit,
    c.current_stock,
    bi.is_optional,
    bi.notes
  FROM public.boms b
  LEFT JOIN public.bom_items bi ON b.id = bi.bom_id
  LEFT JOIN public.components c ON bi.component_id = c.id
  WHERE b.id = p_bom_id
  ORDER BY bi.is_optional, c.name;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- Function: get_boms
CREATE OR REPLACE FUNCTION public.get_boms(p_store text DEFAULT NULL::text, p_is_active boolean DEFAULT true, p_search text DEFAULT NULL::text)
 RETURNS TABLE(id uuid, product_title text, store text, description text, shopify_product_id text, is_active boolean, component_count bigint, created_at timestamp with time zone, updated_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    b.id,
    b.product_title,
    b.store,
    b.description,
    b.shopify_product_id,
    b.is_active,
    COUNT(bi.id)::bigint as component_count,
    b.created_at,
    b.updated_at
  FROM public.boms b
  LEFT JOIN public.bom_items bi ON b.id = bi.bom_id
  WHERE (p_store IS NULL OR b.store = p_store)
    AND (p_is_active IS NULL OR b.is_active = p_is_active)
    AND (p_search IS NULL OR b.product_title ILIKE '%' || p_search || '%')
  GROUP BY b.id, b.product_title, b.store, b.description, b.shopify_product_id, b.is_active, b.created_at, b.updated_at
  ORDER BY b.product_title;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- Function: get_complete_minimal
CREATE OR REPLACE FUNCTION public.get_complete_minimal(p_store text DEFAULT NULL::text, p_limit integer DEFAULT 50)
 RETURNS SETOF vw_complete_minimal
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  select *
  from vw_complete_minimal
  where (p_store is null or store = p_store)
  order by packing_complete_ts desc nulls last
  limit p_limit;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- Function: get_components
CREATE OR REPLACE FUNCTION public.get_components()
 RETURNS TABLE(id uuid, sku text, name text, description text, category text, unit text, current_stock numeric, min_stock numeric, max_stock numeric, cost_per_unit numeric, supplier text, supplier_sku text, is_active boolean, created_at timestamp with time zone, updated_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    c.id, c.sku, c.name, c.description, c.category, c.unit,
    c.current_stock, c.min_stock, c.max_stock, c.cost_per_unit,
    c.supplier, c.supplier_sku, c.is_active, c.created_at, c.updated_at
  FROM public.components c
  WHERE c.is_active = true
  ORDER BY c.name;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- Function: get_components
CREATE OR REPLACE FUNCTION public.get_components(p_category text DEFAULT NULL::text, p_is_active boolean DEFAULT true, p_low_stock_only boolean DEFAULT false, p_search text DEFAULT NULL::text, p_limit integer DEFAULT 100)
 RETURNS TABLE(id uuid, sku text, name text, description text, category text, unit text, current_stock numeric, min_stock numeric, max_stock numeric, cost_per_unit numeric, supplier text, supplier_sku text, is_active boolean, created_at timestamp with time zone, updated_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    c.id, c.sku, c.name, c.description, c.category, c.unit,
    c.current_stock, c.min_stock, c.max_stock, c.cost_per_unit,
    c.supplier, c.supplier_sku, c.is_active, c.created_at, c.updated_at
  FROM public.components c
  WHERE (p_category IS NULL OR c.category = p_category)
    AND (p_is_active IS NULL OR c.is_active = p_is_active)
    AND (p_low_stock_only = false OR c.current_stock < c.min_stock)
    AND (p_search IS NULL OR 
         c.name ILIKE '%' || p_search || '%' OR 
         c.sku ILIKE '%' || p_search || '%')
  ORDER BY c.name
  LIMIT p_limit;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- Function: get_conversation_participants
CREATE OR REPLACE FUNCTION public.get_conversation_participants(p_conversation_id uuid)
 RETURNS TABLE(user_id uuid, full_name text, role text, is_online boolean, joined_at timestamp with time zone)
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  select
    cp.user_id,
    coalesce( (auth.jwt() -> 'user_metadata' ->> 'full_name') , '' )::text as full_name, -- placeholder; wire to your staff table if needed
    cp.role,
    false as is_online, -- placeholder; wire to presence later
    cp.joined_at
  from public.conversation_participants cp
  where cp.conversation_id = p_conversation_id
    and exists (select 1 from public.conversation_participants p
                where p.conversation_id = p_conversation_id and p.user_id = auth.uid());
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- Function: get_conversations
CREATE OR REPLACE FUNCTION public.get_conversations(p_limit integer DEFAULT 50, p_offset integer DEFAULT 0)
 RETURNS TABLE(id uuid, name text, type text, created_by uuid, created_at timestamp with time zone, last_message_text text, last_message_at timestamp with time zone, last_message_sender_id uuid, last_message_sender_name text, unread_count integer, participant_count integer)
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
with mine as (
  select c.*
  from public.conversations c
  join public.conversation_participants p on p.conversation_id = c.id
  where p.user_id = auth.uid()
),
lasts as (
  select distinct on (m.conversation_id)
    m.conversation_id, m.body, m.created_at, m.sender_id, m.sender_name
  from public.messages m
  order by m.conversation_id, m.created_at desc
),
counts as (
  select conversation_id, count(*) as participant_count
  from public.conversation_participants
  group by conversation_id
),
unread as (
  select mc.id as conversation_id,
         case
           when lm.created_at is null then 0
           when r.last_read_at is null then 1
           when lm.created_at > r.last_read_at then 1
           else 0
         end as u
  from mine mc
  left join lasts lm on lm.conversation_id = mc.id
  left join public.message_reads r on r.conversation_id = mc.id and r.user_id = auth.uid()
)
select
  mc.id, mc.name, mc.type, mc.created_by, mc.created_at,
  lm.body as last_message_text,
  lm.created_at as last_message_at,
  lm.sender_id as last_message_sender_id,
  lm.sender_name as last_message_sender_name,
  coalesce(sum(u.u) over (partition by mc.id),0) as unread_count,
  coalesce(ct.participant_count, 0) as participant_count
from mine mc
left join lasts lm on lm.conversation_id = mc.id
left join counts ct on ct.conversation_id = mc.id
left join unread u on u.conversation_id = mc.id
order by coalesce(lm.created_at, mc.created_at) desc
limit p_limit offset p_offset;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- Function: get_due_date_settings
CREATE OR REPLACE FUNCTION public.get_due_date_settings(p_store text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_default_due text;
  v_allowed_days jsonb;
  v_blackout_dates jsonb;
  v_result jsonb;
BEGIN
  -- Validate store
  IF p_store NOT IN ('bannos', 'flourlane', 'global') THEN
    RAISE EXCEPTION 'Invalid store: %', p_store;
  END IF;

  -- Get default due date
  SELECT value INTO v_default_due
  FROM settings 
  WHERE store = p_store AND key = 'dueDates.defaultDue'
  LIMIT 1;

  -- Get allowed days
  SELECT value INTO v_allowed_days
  FROM settings 
  WHERE store = p_store AND key = 'dueDates.allowedDays'
  LIMIT 1;

  -- Get blackout dates
  SELECT value INTO v_blackout_dates
  FROM settings 
  WHERE store = p_store AND key = 'dueDates.blackoutDates'
  LIMIT 1;

  -- Build result object with defaults
  v_result := jsonb_build_object(
    'defaultDue', COALESCE(v_default_due, '+1 day'),
    'allowedDays', COALESCE(v_allowed_days, '[true, true, true, true, true, true, false]'::jsonb),
    'blackoutDates', COALESCE(v_blackout_dates, '["2024-12-25", "2024-01-01"]'::jsonb)
  );

  RETURN v_result;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- Function: get_flavours
CREATE OR REPLACE FUNCTION public.get_flavours(p_store text)
 RETURNS text[]
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_flavours text[];
BEGIN
  -- Validate store
  IF p_store NOT IN ('bannos', 'flourlane', 'global') THEN
    RAISE EXCEPTION 'Invalid store: %', p_store;
  END IF;

  -- Get flavours from settings table
  SELECT COALESCE(
    (SELECT ARRAY(
      SELECT jsonb_array_elements_text(value)
      FROM settings 
      WHERE store = p_store AND key = 'flavours'
      -- REMOVED LIMIT 1 - this was causing only the first flavour to be returned
    )),
    CASE 
      WHEN p_store = 'bannos' THEN ARRAY['Vanilla', 'Chocolate', 'Strawberry', 'Red Velvet', 'Lemon', 'Coffee']
      WHEN p_store = 'flourlane' THEN ARRAY['Vanilla', 'Chocolate', 'Strawberry', 'Red Velvet', 'Lemon', 'Coffee', 'Matcha', 'Salted Caramel']
      ELSE ARRAY['Vanilla', 'Chocolate', 'Strawberry']
    END
  ) INTO v_flavours;

  RETURN v_flavours;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- Function: get_low_stock_components
CREATE OR REPLACE FUNCTION public.get_low_stock_components()
 RETURNS TABLE(id uuid, sku text, name text, current_stock numeric, min_stock numeric, stock_deficit numeric)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    c.id,
    c.sku,
    c.name,
    c.current_stock,
    c.min_stock,
    (c.min_stock - c.current_stock) as stock_deficit
  FROM public.components c
  WHERE c.is_active = true 
    AND c.current_stock < c.min_stock
  ORDER BY (c.min_stock - c.current_stock) DESC;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- Function: get_messages
CREATE OR REPLACE FUNCTION public.get_messages(p_conversation_id uuid, p_limit integer DEFAULT 50)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_user_id UUID;
  v_messages JSONB;
BEGIN
  -- Get current user ID
  v_user_id := auth.uid();
  
  -- Validate user is authenticated
  IF v_user_id IS NULL THEN
    RETURN jsonb_build_object(
      'success', false,
      'message', 'User not authenticated',
      'data', null,
      'error_code', 'AUTH_REQUIRED'
    );
  END IF;
  
  -- Validate user is participant in conversation
  IF NOT EXISTS (
    SELECT 1 FROM public.conversation_participants 
    WHERE conversation_id = p_conversation_id 
    AND participant_id = v_user_id
  ) THEN
    RETURN jsonb_build_object(
      'success', false,
      'message', 'User not participant in conversation',
      'data', null,
      'error_code', 'NOT_PARTICIPANT'
    );
  END IF;
  
  -- Get messages with sender info
  SELECT jsonb_agg(
    jsonb_build_object(
      'id', m.id,
      'content', m.content,
      'sender_id', m.sender_id,
      'sender_name', s.full_name,
      'created_at', m.created_at,
      'read_by', m.read_by
    ) ORDER BY m.created_at DESC
  )
  INTO v_messages
  FROM public.messages m
  JOIN public.staff_shared s ON s.user_id = m.sender_id
  WHERE m.conversation_id = p_conversation_id
  LIMIT p_limit;
  
  RETURN jsonb_build_object(
    'success', true,
    'message', 'Messages retrieved successfully',
    'data', COALESCE(v_messages, '[]'::jsonb),
    'error_code', null
  );
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- Function: get_messages_debug
CREATE OR REPLACE FUNCTION public.get_messages_debug(p_conversation_id uuid)
 RETURNS TABLE(debug_info text, user_id uuid, is_participant boolean, message_count bigint)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_user_id UUID;
  v_is_participant BOOLEAN;
  v_message_count BIGINT;
BEGIN
  v_user_id := auth.uid();
  
  v_is_participant := EXISTS (
    SELECT 1 FROM public.conversation_participants 
    WHERE conversation_id = p_conversation_id 
    AND participant_id = v_user_id
  );
  
  v_message_count := (
    SELECT COUNT(*) FROM public.messages 
    WHERE conversation_id = p_conversation_id
  );
  
  RETURN QUERY
  SELECT 
    'Debug info'::text as debug_info,
    v_user_id,
    v_is_participant,
    v_message_count;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- Function: get_messages_temp
CREATE OR REPLACE FUNCTION public.get_messages_temp(p_conversation_id uuid, p_limit integer DEFAULT 50, p_offset integer DEFAULT 0)
 RETURNS TABLE(id bigint, body text, sender_id uuid, sender_name text, created_at timestamp with time zone, is_own_message boolean)
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  select
    m.id, m.body, m.sender_id, m.sender_name, m.created_at,
    (m.sender_id = auth.uid()) as is_own_message
  from public.messages m
  where m.conversation_id = p_conversation_id
    and exists (select 1 from public.conversation_participants p
                where p.conversation_id = m.conversation_id
                  and p.user_id = auth.uid())
  order by m.created_at asc
  limit p_limit offset p_offset
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- Function: get_messages_temp_test
CREATE OR REPLACE FUNCTION public.get_messages_temp_test(p_conversation_id uuid, p_limit integer DEFAULT 50, p_offset integer DEFAULT 0)
 RETURNS TABLE(id uuid, body text, sender_id uuid, sender_name text, created_at timestamp with time zone, is_own_message boolean)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Return messages WITHOUT authentication check for testing
  RETURN QUERY
  SELECT 
    m.id,
    m.content as body,
    m.sender_id,
    s.full_name as sender_name,
    m.created_at,
    false as is_own_message  -- Set to false for testing
  FROM public.messages m
  JOIN public.staff_shared s ON s.user_id = m.sender_id
  WHERE m.conversation_id = p_conversation_id
  ORDER BY m.created_at DESC
  LIMIT p_limit
  OFFSET p_offset;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- Function: get_monitor_density
CREATE OR REPLACE FUNCTION public.get_monitor_density(p_store text)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_density text;
BEGIN
  -- Validate store
  IF p_store NOT IN ('bannos', 'flourlane', 'global') THEN
    RAISE EXCEPTION 'Invalid store: %', p_store;
  END IF;

  -- Get monitor density from settings table
  SELECT COALESCE(
    (SELECT value#>>'{}'  -- Extract raw string from JSONB
     FROM settings 
     WHERE store = p_store AND key = 'monitor.density'
     LIMIT 1),
    'cozy' -- Default value
  ) INTO v_density;

  RETURN v_density;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- Function: get_order_for_scan
CREATE OR REPLACE FUNCTION public.get_order_for_scan(p_code text)
 RETURNS orders
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  s text := lower(trim(p_code));
  v_store text;
  v_num bigint;
  v_id uuid;
  v_row public.orders;
begin
  -- UUID direct
  if s ~ '^[0-9a-f-]{36}$' then
    begin v_id := s::uuid; exception when others then v_id := null; end;
    if v_id is not null then
      select * into v_row from public.orders where id = v_id limit 1;
      return v_row;
    end if;
  end if;

  -- Exact barcode match
  select * into v_row from public.orders where barcode = p_code limit 1;
  if found then return v_row; end if;

  -- bannos-##### / flourlane-##### / plain number
  if s like 'bannos-%' then
    v_store := 'bannos';
    begin v_num := substring(s from 'bannos-(\d+)')::bigint; exception when others then v_num := null; end;
  elsif s like 'flourlane-%' then
    v_store := 'flourlane';
    begin v_num := substring(s from 'flourlane-(\d+)')::bigint; exception when others then v_num := null; end;
  elsif s ~ '^\d+$' then
    v_num := s::bigint;
  end if;

  -- store + number
  if v_store is not null and v_num is not null then
    select * into v_row from public.orders where store = v_store and shopify_order_number = v_num limit 1;
    if found then return v_row; end if;
  end if;

  -- number only across stores
  if v_num is not null then
    select * into v_row from public.orders where shopify_order_number = v_num limit 1;
    if found then return v_row; end if;
  end if;

  return v_row; -- null if no match
end
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- Function: get_printing_settings
CREATE OR REPLACE FUNCTION public.get_printing_settings(p_store text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Return default printing settings
  RETURN jsonb_build_object(
    'printer_name', 'Default Printer',
    'paper_size', 'A4',
    'orientation', 'portrait',
    'auto_print', true,
    'print_barcodes', true,
    'print_labels', true
  );
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- Function: get_product_requirements
CREATE OR REPLACE FUNCTION public.get_product_requirements(p_shopify_product_id text DEFAULT NULL::text, p_search text DEFAULT NULL::text)
 RETURNS TABLE(id uuid, shopify_product_id text, shopify_variant_id text, product_title text, component_id uuid, component_name text, component_sku text, quantity_per_unit numeric, current_stock numeric, is_optional boolean, auto_deduct boolean, created_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    pr.id,
    pr.shopify_product_id,
    pr.shopify_variant_id,
    pr.product_title,
    c.id as component_id,
    c.name as component_name,
    c.sku as component_sku,
    pr.quantity_per_unit,
    c.current_stock,
    pr.is_optional,
    pr.auto_deduct,
    pr.created_at
  FROM public.product_requirements pr
  JOIN public.components c ON pr.component_id = c.id
  WHERE (p_shopify_product_id IS NULL OR pr.shopify_product_id = p_shopify_product_id)
    AND (p_search IS NULL OR 
         pr.product_title ILIKE '%' || p_search || '%' OR 
         c.name ILIKE '%' || p_search || '%')
  ORDER BY pr.product_title, c.name;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- Function: get_queue
CREATE OR REPLACE FUNCTION public.get_queue(p_store text DEFAULT NULL::text, p_stage text DEFAULT NULL::text, p_assignee_id uuid DEFAULT NULL::uuid, p_search text DEFAULT NULL::text, p_priority text DEFAULT NULL::text, p_storage text DEFAULT NULL::text, p_offset integer DEFAULT 0, p_limit integer DEFAULT 50, p_sort_by text DEFAULT 'priority'::text, p_sort_order text DEFAULT 'DESC'::text)
 RETURNS TABLE(id text, shopify_order_id bigint, shopify_order_number integer, customer_name text, product_title text, flavour text, notes text, currency character, total_amount numeric, stage stage_type, priority priority_level, due_date date, delivery_method text, size text, item_qty integer, storage text, assignee_id uuid, assignee_name text, store text, created_at timestamp with time zone, updated_at timestamp with time zone, total_count bigint)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  IF p_store = 'bannos' OR p_store IS NULL THEN
    RETURN QUERY
    SELECT 
      o.id,
      o.shopify_order_id,
      o.shopify_order_number,
      o.customer_name,
      o.product_title,
      o.flavour,
      o.notes,
      o.currency,
      o.total_amount,
      o.stage,
      o.priority,
      o.due_date,
      o.delivery_method,
      o.size,
      o.item_qty,
      o.storage,
      o.assignee_id,
      s.full_name as assignee_name,
      'bannos'::text as store,
      o.created_at,
      o.updated_at,
      COUNT(*) OVER() as total_count
    FROM public.orders_bannos o
    LEFT JOIN public.staff_shared s ON o.assignee_id = s.user_id
    WHERE (p_stage IS NULL OR o.stage::text = p_stage)
      AND (p_assignee_id IS NULL OR o.assignee_id = p_assignee_id)
      AND (p_priority IS NULL OR o.priority::text = p_priority)
      AND (p_storage IS NULL OR o.storage = p_storage)
      AND (p_search IS NULL OR 
           o.customer_name ILIKE '%' || p_search || '%' OR 
           o.product_title ILIKE '%' || p_search || '%' OR
           o.id ILIKE '%' || p_search || '%')
    ORDER BY 
      CASE WHEN p_sort_by = 'priority' AND p_sort_order = 'DESC' THEN o.priority END DESC,
      CASE WHEN p_sort_by = 'priority' AND p_sort_order = 'ASC' THEN o.priority END ASC,
      CASE WHEN p_sort_by = 'due_date' AND p_sort_order = 'DESC' THEN o.due_date END DESC,
      CASE WHEN p_sort_by = 'due_date' AND p_sort_order = 'ASC' THEN o.due_date END ASC,
      o.created_at ASC
    LIMIT p_limit OFFSET p_offset;
  END IF;

  IF p_store = 'flourlane' OR p_store IS NULL THEN
    RETURN QUERY
    SELECT 
      o.id,
      o.shopify_order_id,
      o.shopify_order_number,
      o.customer_name,
      o.product_title,
      o.flavour,
      o.notes,
      o.currency,
      o.total_amount,
      o.stage,
      o.priority,
      o.due_date,
      o.delivery_method,
      o.size,
      o.item_qty,
      o.storage,
      o.assignee_id,
      s.full_name as assignee_name,
      'flourlane'::text as store,
      o.created_at,
      o.updated_at,
      COUNT(*) OVER() as total_count
    FROM public.orders_flourlane o
    LEFT JOIN public.staff_shared s ON o.assignee_id = s.user_id
    WHERE (p_stage IS NULL OR o.stage::text = p_stage)
      AND (p_assignee_id IS NULL OR o.assignee_id = p_assignee_id)
      AND (p_priority IS NULL OR o.priority::text = p_priority)
      AND (p_storage IS NULL OR o.storage = p_storage)
      AND (p_search IS NULL OR 
           o.customer_name ILIKE '%' || p_search || '%' OR 
           o.product_title ILIKE '%' || p_search || '%' OR
           o.id ILIKE '%' || p_search || '%')
    ORDER BY 
      CASE WHEN p_sort_by = 'priority' AND p_sort_order = 'DESC' THEN o.priority END DESC,
      CASE WHEN p_sort_by = 'priority' AND p_sort_order = 'ASC' THEN o.priority END ASC,
      CASE WHEN p_sort_by = 'due_date' AND p_sort_order = 'DESC' THEN o.due_date END DESC,
      CASE WHEN p_sort_by = 'due_date' AND p_sort_order = 'ASC' THEN o.due_date END ASC,
      o.created_at ASC
    LIMIT p_limit OFFSET p_offset;
  END IF;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- Function: get_queue_minimal
CREATE OR REPLACE FUNCTION public.get_queue_minimal(p_store text DEFAULT NULL::text, p_limit integer DEFAULT 100, p_offset integer DEFAULT 0)
 RETURNS SETOF vw_queue_minimal
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  select *
  from vw_queue_minimal
  where (p_store is null or store = p_store)
  order by due_date asc nulls last, created_at asc
  limit p_limit offset p_offset;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- Function: get_queue_stats
CREATE OR REPLACE FUNCTION public.get_queue_stats(p_store text)
 RETURNS TABLE(total_orders bigint, completed_orders bigint, in_production bigint, unassigned_orders bigint, filling_count bigint, covering_count bigint, decorating_count bigint, packing_count bigint)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_table_name text;
BEGIN
  v_table_name := 'orders_' || p_store;
  
  RETURN QUERY EXECUTE format('
    SELECT 
      COUNT(*)::bigint as total_orders,
      COUNT(*) FILTER (WHERE stage = ''Complete'')::bigint as completed_orders,
      COUNT(*) FILTER (WHERE stage != ''Complete'')::bigint as in_production,
      COUNT(*) FILTER (WHERE assignee_id IS NULL AND stage != ''Complete'')::bigint as unassigned_orders,
      COUNT(*) FILTER (WHERE stage = ''Filling'')::bigint as filling_count,
      COUNT(*) FILTER (WHERE stage = ''Covering'')::bigint as covering_count,
      COUNT(*) FILTER (WHERE stage = ''Decorating'')::bigint as decorating_count,
      COUNT(*) FILTER (WHERE stage = ''Packing'')::bigint as packing_count
    FROM public.%I
  ', v_table_name);
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- Function: get_setting
CREATE OR REPLACE FUNCTION public.get_setting(p_store text, p_key text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_value jsonb;
BEGIN
  -- Validate store
  IF p_store NOT IN ('bannos', 'flourlane', 'global') THEN
    RAISE EXCEPTION 'Invalid store: %', p_store;
  END IF;

  -- Get setting value
  SELECT value INTO v_value
  FROM public.settings
  WHERE store = p_store AND key = p_key
  LIMIT 1;

  RETURN v_value;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- Function: get_settings
CREATE OR REPLACE FUNCTION public.get_settings(p_store text)
 RETURNS TABLE(store text, key text, value jsonb, created_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Validate store
  IF p_store NOT IN ('bannos', 'flourlane', 'global') THEN
    RAISE EXCEPTION 'Invalid store: %', p_store;
  END IF;

  RETURN QUERY
  SELECT 
    s.store,
    s.key,
    s.value,
    s.created_at
  FROM public.settings s
  WHERE s.store = p_store
  ORDER BY s.key;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- Function: get_staff
CREATE OR REPLACE FUNCTION public.get_staff()
 RETURNS TABLE(user_id uuid, full_name text, role text)
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  select s.user_id, s.full_name, s.role
  from public.staff_shared s
  order by s.full_name;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- Function: get_staff_list
CREATE OR REPLACE FUNCTION public.get_staff_list(p_role text DEFAULT NULL::text, p_is_active boolean DEFAULT true)
 RETURNS TABLE(user_id uuid, full_name text, email text, role text, store text, is_active boolean, phone text, created_at timestamp with time zone, updated_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    s.user_id,
    s.full_name,
    s.email,
    s.role,
    s.store,
    s.is_active,
    s.phone,
    s.created_at,
    s.updated_at
  FROM public.staff_shared s
  WHERE (p_role IS NULL OR s.role = p_role)
    AND (p_is_active IS NULL OR s.is_active = p_is_active)
  ORDER BY s.full_name;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- Function: get_staff_me
CREATE OR REPLACE FUNCTION public.get_staff_me()
 RETURNS TABLE(user_id uuid, full_name text, role text, store text, is_active boolean, phone text, email text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  IF auth.uid() IS NULL THEN
    RAISE EXCEPTION 'Not authenticated';
  END IF;

  RETURN QUERY
  SELECT 
    s.user_id,
    s.full_name,
    s.role,
    s.store,
    s.is_active,
    s.phone,
    s.email
  FROM public.staff_shared s
  WHERE s.user_id = auth.uid();
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- Function: get_staff_member
CREATE OR REPLACE FUNCTION public.get_staff_member(p_user_id uuid)
 RETURNS TABLE(user_id uuid, full_name text, role text, store text, is_active boolean, phone text, email text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Check if user_id is provided
  IF p_user_id IS NULL THEN
    RAISE EXCEPTION 'User ID is required';
  END IF;

  -- Return staff member data
  RETURN QUERY
  SELECT
    s.user_id,
    s.full_name,
    s.role,
    s.store,
    s.is_active,
    s.phone,
    s.email
  FROM public.staff_shared s
  WHERE s.user_id = p_user_id
    AND s.is_active = true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- Function: get_staff_stats
CREATE OR REPLACE FUNCTION public.get_staff_stats()
 RETURNS TABLE(user_id uuid, assigned_orders bigint)
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  with all_orders as (
    select assignee_id from public.orders_bannos
    union all
    select assignee_id from public.orders_flourlane
  )
  select s.user_id,
         count(a.assignee_id)::bigint as assigned_orders
  from public.staff_shared s
  left join all_orders a on a.assignee_id = s.user_id
  group by s.user_id
  order by assigned_orders desc nulls last;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- Function: get_stock_transactions
CREATE OR REPLACE FUNCTION public.get_stock_transactions(p_component_id uuid DEFAULT NULL::uuid, p_order_id text DEFAULT NULL::text, p_transaction_type text DEFAULT NULL::text, p_limit integer DEFAULT 100)
 RETURNS TABLE(id uuid, component_id uuid, component_name text, component_sku text, transaction_type text, quantity_change numeric, quantity_before numeric, quantity_after numeric, reference_order_id text, reason text, performed_by uuid, performer_name text, created_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    st.id,
    st.component_id,
    c.name as component_name,
    c.sku as component_sku,
    st.transaction_type,
    st.quantity_change,
    st.quantity_before,
    st.quantity_after,
    st.reference_order_id,
    st.reason,
    st.performed_by,
    s.full_name as performer_name,
    st.created_at
  FROM public.stock_transactions st
  JOIN public.components c ON st.component_id = c.id
  LEFT JOIN public.staff_shared s ON st.performed_by = s.user_id
  WHERE (p_component_id IS NULL OR st.component_id = p_component_id)
    AND (p_order_id IS NULL OR st.reference_order_id = p_order_id)
    AND (p_transaction_type IS NULL OR st.transaction_type = p_transaction_type)
  ORDER BY st.created_at DESC
  LIMIT p_limit;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- Function: get_storage_locations
CREATE OR REPLACE FUNCTION public.get_storage_locations(p_store text)
 RETURNS text[]
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_locations text[];
BEGIN
  -- Validate store
  IF p_store NOT IN ('bannos', 'flourlane', 'global') THEN
    RAISE EXCEPTION 'Invalid store: %', p_store;
  END IF;

  -- Get storage locations from settings table
  SELECT COALESCE(
    (SELECT ARRAY(
      SELECT jsonb_array_elements_text(value)
      FROM settings 
      WHERE store = p_store AND key = 'storage_locations'
      -- Removed LIMIT 1 here
    )),
    CASE 
      WHEN p_store = 'bannos' THEN ARRAY['Store Fridge', 'Store Freezer', 'Kitchen Coolroom', 'Kitchen Freezer', 'Basement Coolroom']
      WHEN p_store = 'flourlane' THEN ARRAY['Store Fridge', 'Store Freezer', 'Kitchen Coolroom', 'Kitchen Freezer', 'Basement Coolroom', 'Display Case']
      ELSE ARRAY['General Storage', 'Cold Storage', 'Freezer Storage']
    END
  ) INTO v_locations;

  RETURN v_locations;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- Function: get_unassigned_counts
CREATE OR REPLACE FUNCTION public.get_unassigned_counts(p_store text)
 RETURNS TABLE(stage text, count bigint)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_table_name text;
BEGIN
  v_table_name := 'orders_' || p_store;
  
  RETURN QUERY EXECUTE format('
    SELECT 
      stage::text,
      COUNT(*)::bigint
    FROM public.%I
    WHERE assignee_id IS NULL AND stage != ''Complete''
    GROUP BY stage
    ORDER BY stage
  ', v_table_name);
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- Function: get_unread_count
CREATE OR REPLACE FUNCTION public.get_unread_count()
 RETURNS integer
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
with my_convos as (
  select c.id
  from public.conversations c
  join public.conversation_participants p on p.conversation_id = c.id
  where p.user_id = auth.uid()
),
last_msg as (
  select conversation_id, max(created_at) as last_msg_at
  from public.messages
  group by conversation_id
)
select coalesce(count(*),0)
from my_convos mc
left join last_msg lm on lm.conversation_id = mc.id
left join public.message_reads r on r.conversation_id = mc.id and r.user_id = auth.uid()
where lm.last_msg_at is not null
  and (r.last_read_at is null or lm.last_msg_at > r.last_read_at);
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- Function: handle_print_barcode
CREATE OR REPLACE FUNCTION public.handle_print_barcode(p_order_id uuid, p_barcode text)
 RETURNS orders
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_before public.stage;
  v_after  public.stage;
  v_row    public.orders;
begin
  perform public._order_lock(p_order_id);

  select stage into v_before from public.orders where id = p_order_id for update;
  if not found then raise exception 'ORDER_NOT_FOUND'; end if;

  if exists (select 1 from public.orders where id = p_order_id and barcode is not null and barcode <> p_barcode)
  then raise exception 'BARCODE_MISMATCH'; end if;

  update public.orders
     set barcode = coalesce(barcode, p_barcode),
         filling_start_ts = coalesce(filling_start_ts, now()),
         stage = case when stage = 'Filling_pending' then 'Filling_in_progress' else stage end,
         updated_at = now()
   where id = p_order_id
  returning * into v_row;

  v_after := v_row.stage;
  if v_after is distinct from v_before then
    insert into public.stage_events(order_id, from_stage, to_stage, performed_by, reason)
    values (p_order_id, v_before, v_after, null, 'print_barcode');
  end if;

  insert into public.audit_log(action, performed_by, source, meta)
  values ('handle_print_barcode', null, 'rpc', jsonb_build_object('order_id', p_order_id, 'barcode', p_barcode));

  return v_row;
end
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- Function: ingest_order
CREATE OR REPLACE FUNCTION public.ingest_order(payload jsonb DEFAULT NULL::jsonb, normalized jsonb DEFAULT NULL::jsonb)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare
  v_enabled boolean := public.settings_get_bool('global','ingest', false);
  v_in      jsonb    := coalesce(payload, normalized);  -- < accept either key

  v_shop_domain text := coalesce(v_in->>'shop_domain', v_in->>'domain', v_in->'shop'->>'domain');
  v_store       text;

  v_gid             text := v_in->>'admin_graphql_api_id';
  v_shopify_id      text := v_in->>'id';
  v_order_number    text := coalesce(v_in->>'order_number', v_in->>'name');

  v_customer_name   text := coalesce(
                          v_in->'shipping_address'->>'name',
                          v_in->'customer'->>'name',
                          trim(concat_ws(' ', v_in->'customer'->>'first_name', v_in->'customer'->>'last_name'))
                        );
  v_notes           text := coalesce(v_in->>'note','');
  v_delivery_instr  text;

  v_method_raw      text;
  v_delivery_method text;
  v_due_raw         text;
  v_due_text        text;
  v_delivery_date   date;

  v_currency        text := coalesce(v_in->>'presentment_currency', v_in->>'currency');
  v_total_amount    numeric(12,2) := coalesce(nullif(v_in->>'current_total_price','')::numeric,
                                             nullif(v_in->>'total_price','')::numeric, 0);

  v_line            jsonb;
  v_product_title   text;
  v_item_qty        integer;
  v_flavour         text;
begin
  if not v_enabled then return; end if;

  v_store := case
    when v_shop_domain ilike '%bannos%'    then 'bannos'
    when v_shop_domain ilike '%flourlane%' then 'flourlane'
    else null
  end;
  if v_store is null then
    raise exception 'Unknown shop domain: %', coalesce(v_shop_domain, '<null>');
  end if;

  if v_gid is null then
    raise exception 'Missing admin_graphql_api_id';
  end if;

  -- primary line item: first non-gift with qty > 0
  select li
  into v_line
  from jsonb_array_elements(coalesce(v_in->'line_items','[]'::jsonb)) li
  where coalesce((li->>'gift_card')::boolean, false) = false
    and coalesce((li->>'quantity')::int, 0) > 0
  limit 1;

  v_product_title := coalesce(v_line->>'title','');
  v_item_qty      := nullif(v_line->>'quantity','')::int;

  -- flavour: "gelato flavour(s)" (skip internal keys)  variant_title fallback
  with props as (
    select p
    from jsonb_array_elements(coalesce(v_line->'properties','[]'::jsonb)) p
  ),
  visible as (
    select p
    from props
    where not (
      coalesce(lower(p->>'name'), lower(p->>'first'), '') like '\_%' escape '\'
      or coalesce(lower(p->>'name'), lower(p->>'first'), '') ~ '_origin|_raw|gwp|_LocalDeliveryID'
    )
  ),
  hit as (
    select p
    from visible
    where coalesce(p->>'name', p->>'first') ~* 'gelato flavour(s)?'
       or lower(coalesce(p->>'name', p->>'first')) in ('flavour','flavor')
    limit 1
  )
  select string_agg(trim(x), ', ') into v_flavour
  from (
    select unnest(regexp_split_to_array(coalesce((select h.p->>'value' from hit h), ''), E'\\r?\\n|,|/')) x
  ) s
  where x <> '';

  if coalesce(v_flavour,'') = '' then
    v_flavour := coalesce(split_part(coalesce(v_line->>'variant_title',''), ',', 1), '');
    if position('/' in v_flavour) > 0 then
      v_flavour := split_part(v_flavour, '/', 1);
    end if;
  end if;

  -- delivery method (attributes first)
  select na->>'value' into v_method_raw
  from jsonb_path_query(v_in, '$.note_attributes[*] ? (@.name != null)') as na
  where lower(na->>'name') in ('delivery method','pickup or delivery')
  limit 1;
  if v_method_raw is not null then
    v_delivery_method := case when lower(v_method_raw) ~ 'pickup|pick up' then 'pickup' else 'delivery' end;
  end if;

  -- delivery date (strip between  then parse)
  select na->>'value' into v_due_raw
  from jsonb_path_query(v_in, '$.note_attributes[*] ? (@.name != null)') as na
  where lower(na->>'name') in ('local delivery date and time','delivery date','pickup date')
  limit 1;
  if v_due_raw is not null then
    v_due_text := split_part(v_due_raw, 'between', 1);
    begin
      v_delivery_date := v_due_text::date;
    exception when others then
      begin
        v_delivery_date := to_date(regexp_replace(v_due_text, '.*?(\d{4}-\d{2}-\d{2}).*', '\1'), 'YYYY-MM-DD');
      exception when others then
        v_delivery_date := null;
      end;
    end;
  end if;

  -- notes aggregation: order note + Delivery Instructions
  select na->>'value' into v_delivery_instr
  from jsonb_path_query(v_in, '$.note_attributes[*] ? (@.name != null)') as na
  where lower(na->>'name') = 'delivery instructions'
  limit 1;
  if coalesce(v_delivery_instr,'') <> '' then
    v_notes := trim(both ' ' from concat_ws('  ', nullif(v_notes,''), v_delivery_instr));
  end if;

  -- INSERT (human_id is filled by trigger)
  insert into public.orders (
    store, shopify_order_id, shopify_order_gid, order_number,
    customer_name, delivery_date, delivery_method, product_title, flavour,
    item_qty, notes, currency, total_amount, order_json
  )
  values (
    v_store, v_shopify_id, v_gid, v_order_number,
    v_customer_name, v_delivery_date, v_delivery_method, v_product_title, v_flavour,
    v_item_qty, v_notes, v_currency, v_total_amount, v_in
  )
  on conflict (shopify_order_gid) do nothing;
end
$function$
;

 |
| -- Function: ingest_order
CREATE OR REPLACE FUNCTION public.ingest_order(p_shop_domain text, payload jsonb DEFAULT NULL::jsonb, normalized jsonb DEFAULT NULL::jsonb)
 RETURNS void
 LANGUAGE sql
 SECURITY DEFINER
AS $function$
  select public.ingest_order(
    coalesce(payload, normalized) || jsonb_build_object('shop_domain', p_shop_domain),
    null
  );
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- Function: is_cake_item
CREATE OR REPLACE FUNCTION public.is_cake_item(p_item jsonb)
 RETURNS boolean
 LANGUAGE sql
 IMMUTABLE
AS $function$
  select coalesce( (p_item->>'product_type') ilike '%cake%'
                or (p_item->>'title') ilike '%cake%', false )
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- Function: mark_messages_read
CREATE OR REPLACE FUNCTION public.mark_messages_read(p_conversation_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare v_me uuid := auth.uid();
begin
  if v_me is null then raise exception 'Not authenticated'; end if;

  insert into public.message_reads(conversation_id, user_id, last_read_at)
  values (p_conversation_id, v_me, now())
  on conflict (conversation_id, user_id) do update set last_read_at = excluded.last_read_at;

  return true;
end;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- Function: move_to_filling_with_assignment
CREATE OR REPLACE FUNCTION public.move_to_filling_with_assignment(p_order_id uuid, p_staff_id uuid)
 RETURNS orders
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_before public.stage;
  v_after  public.stage;
  v_row    public.orders;
begin
  perform public._order_lock(p_order_id);

  select stage into v_before from public.orders where id = p_order_id for update;
  if not found then raise exception 'ORDER_NOT_FOUND'; end if;

  update public.orders
     set assignee_id = p_staff_id,
         stage = case when stage in ('Filling_pending','Filling_in_progress') then 'Filling_in_progress' else stage end,
         updated_at = now()
   where id = p_order_id
  returning * into v_row;

  v_after := v_row.stage;
  if v_after is distinct from v_before then
    insert into public.stage_events(order_id, from_stage, to_stage, performed_by, reason)
    values (p_order_id, v_before, v_after, null, 'assign_to_filling');
  end if;

  insert into public.audit_log(action, performed_by, source, meta)
  values ('move_to_filling_with_assignment', null, 'rpc', jsonb_build_object('order_id', p_order_id, 'staff_id', p_staff_id));

  return v_row;
end
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- Function: orders_set_human_id
CREATE OR REPLACE FUNCTION public.orders_set_human_id()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
  new.human_id := new.store::text || '-' ||
                  coalesce(
                    nullif(new.order_number::text, ''),
                    nullif(new.shopify_order_number::text, ''),
                    new.shopify_order_id::text
                  );
  return new;
end
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- Function: process_kitchen_task_create
CREATE OR REPLACE FUNCTION public.process_kitchen_task_create(p_limit integer DEFAULT 20, p_lock_secs integer DEFAULT 60)
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_now timestamptz := now();
  v_count int := 0;
  v_job record;
  v_p jsonb;
  v_shop text;
  v_order uuid;   -- set per job, deterministically
  v_suffix text;
begin
  -- Validate inputs (defensive)
  if p_limit < 1 or p_limit > 100 then
    raise exception 'p_limit must be between 1 and 100';
  end if;
  if p_lock_secs < 1 or p_lock_secs > 3600 then
    raise exception 'p_lock_secs must be between 1 and 3600';
  end if;

  for v_job in
    select *
      from public.work_queue
     where status = 'pending'
       and topic  = 'kitchen_task_create'
       and (locked_at is null or locked_at < v_now - make_interval(secs => p_lock_secs))
     order by created_at asc
     limit p_limit
     for update skip locked
  loop
    begin
      update public.work_queue
         set locked_at = v_now, locked_by = 'stage-ticket-worker', status='processing'
       where id = v_job.id;

      v_p    := v_job.payload;
      v_shop := v_p->>'shop_domain';
      if v_shop is null then
        raise exception 'missing payload: shop_domain';
      end if;

      -- Deterministic order UUID: use parent webhook id (Shopify header) we stored in worker #1.
      -- All A/B/C tasks from the same order share this UUID; retries reuse it exactly.
      v_order := nullif(v_p->>'parent_hook_id','')::uuid;
      if v_order is null then
        -- fallback (rare): stable per job id
        v_order := v_job.id; -- requires work_queue.id to be uuid (it is in your DB)
      end if;

      -- Extract and validate suffix (A/B/C)
      v_suffix := nullif(v_p->>'task_suffix','');
      if v_suffix is null then
        raise exception 'missing payload: task_suffix';
      end if;
      if v_suffix !~ '^[A-Z]+$' then
        raise exception 'invalid task_suffix: %', v_suffix;
      end if;

      insert into public.stage_events(order_id, shop_domain, stage, status, task_suffix)
      values (v_order, v_shop, 'Filling', 'pending', v_suffix)
      on conflict (order_id, shop_domain, stage, task_suffix) do nothing;

      update public.work_queue set status='done', updated_at=now() where id=v_job.id;
      v_count := v_count + 1;

    exception when others then
      insert into public.dead_letter(created_at, payload, reason)
      values (
        now(),
        jsonb_build_object('worker','process_kitchen_task_create','job_id',v_job.id,'error',SQLERRM),
        'stage_ticket_failed'
      );
      update public.work_queue set status='error', updated_at=now() where id=v_job.id;
    end;
  end loop;

  return v_count;
end;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- Function: process_webhook_order_split
CREATE OR REPLACE FUNCTION public.process_webhook_order_split(p_limit integer DEFAULT 10, p_lock_secs integer DEFAULT 60)
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_now timestamptz := now();
  v_count int := 0;
  v_job record;
  v_payload jsonb;
  v_items jsonb;
  v_cakes jsonb := '[]'::jsonb;
  v_accessories jsonb := '[]'::jsonb;
  v_shop text;
  v_topic text;
  v_hook text;
  v_body jsonb;
  i int := 0;
  v_suffix text;
begin
  -- lock a batch of jobs
  for v_job in
    select *
    from public.work_queue
    where status = 'pending'
      and topic = 'webhook_order_split'
      and (locked_at is null or locked_at < v_now - make_interval(secs => p_lock_secs))
    order by created_at asc
    limit p_limit
    for update skip locked
  loop
    begin
      -- lock
      update public.work_queue
         set locked_at = v_now,
             locked_by = 'order-split-worker',
             status = 'processing'
       where id = v_job.id;

      v_payload := v_job.payload;
      v_shop    := (v_payload->>'shop_domain');
      v_topic   := (v_payload->>'topic');
      v_hook    := (v_payload->>'hook_id');
      v_body    := (v_payload->'body');

      -- Validate required fields
      if v_shop is null or v_topic is null or v_hook is null or v_body is null then
        raise exception 'Missing required payload fields (shop_domain/topic/hook_id/body)';
      end if;

      -- Expect Shopify order payload with line_items array
      v_items := coalesce(v_body->'line_items', '[]'::jsonb);

      -- Separate cakes vs accessories
      v_cakes := '[]'::jsonb;
      v_accessories := '[]'::jsonb;
      for i in 0 .. coalesce(jsonb_array_length(v_items), 0)-1 loop
        if public.is_cake_item(v_items->i) then
          -- push N times by quantity
          for _q in 1 .. coalesce(((v_items->i)->>'quantity')::int, 1) loop
            v_cakes := v_cakes || jsonb_build_array(v_items->i);
          end loop;
        else
          v_accessories := v_accessories || jsonb_build_array(v_items->i);
        end if;
      end loop;

      if jsonb_array_length(v_cakes) = 0 then
        update public.work_queue set status = 'done', updated_at = now() where id = v_job.id;
        v_count := v_count + 1;
        continue;
      end if;

      -- Emit one child job per cake with A/B/C; accessories only on A
      for i in 0 .. coalesce(jsonb_array_length(v_cakes), 0)-1 loop
        v_suffix := public.alpha_suffix(i);
        insert into public.work_queue (topic, payload, status)
        values (
          'kitchen_task_create',
          jsonb_build_object(
            'shop_domain', v_shop,
            'parent_hook_id', v_hook,
            'parent_topic', v_topic,
            'order_id', coalesce(v_body->>'id', v_body->>'order_number'),
            'task_suffix', v_suffix,
            'line_item', v_cakes->i,
            'accessories', case when i = 0 then v_accessories else '[]'::jsonb end
          ),
          'pending'
        );
      end loop;

      -- complete parent
      update public.work_queue
         set status = 'done',
             updated_at = now()
       where id = v_job.id;

      v_count := v_count + 1;

    exception when others then
      -- mark error and keep evidence
      insert into public.dead_letter (created_at, payload, reason)
      values (now(),
              jsonb_build_object(
                'worker', 'process_webhook_order_split',
                'error', SQLERRM,
                'job_id', v_job.id,
                'hook_id', v_hook,
                'shop_domain', v_shop
              ),
              'split_worker_failed');

      update public.work_queue
         set status = 'error',
             updated_at = now()
       where id = v_job.id;
    end;
  end loop;

  return v_count;
end;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- Function: qc_return_to_decorating
CREATE OR REPLACE FUNCTION public.qc_return_to_decorating(p_order_id uuid, p_reason text)
 RETURNS orders
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_before public.stage;
  v_row    public.orders;
begin
  perform public._order_lock(p_order_id);

  select stage into v_before from public.orders where id = p_order_id for update;
  if not found then raise exception 'ORDER_NOT_FOUND'; end if;

  update public.orders
     set stage = 'Decorating_pending',
         updated_at = now()
   where id = p_order_id
     and v_before = 'Packing_in_progress'
  returning * into v_row;

  if not found then
    select * into v_row from public.orders where id = p_order_id;
    return v_row;
  end if;

  insert into public.stage_events(order_id, from_stage, to_stage, performed_by, reason)
  values (p_order_id, v_before, 'Decorating_pending', null, coalesce(p_reason,'qc_return'));

  insert into public.audit_log(action, performed_by, source, meta)
  values ('qc_return_to_decorating', null, 'rpc', jsonb_build_object('order_id', p_order_id, 'reason', p_reason));

  return v_row;
end
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- Function: record_component_txn
CREATE OR REPLACE FUNCTION public.record_component_txn(p_component_id uuid, p_qty_delta numeric, p_reason text, p_ref text DEFAULT NULL::text)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare
  v_txn_id uuid;
  v_onhand numeric;
begin
  -- Optional safety: prevent negative stock
  select coalesce(sum(qty_delta),0) into v_onhand
  from public.component_txns
  where component_id = p_component_id;

  if v_onhand + p_qty_delta < 0 then
    raise exception 'Insufficient stock for component % (onhand %, delta %)', p_component_id, v_onhand, p_qty_delta;
  end if;

  insert into public.component_txns (component_id, qty_delta, reason, ref)
  values (p_component_id, p_qty_delta, p_reason, p_ref)
  returning id into v_txn_id;

  return v_txn_id;
end $function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- Function: remove_bom_component
CREATE OR REPLACE FUNCTION public.remove_bom_component(p_bom_id uuid, p_component_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  DELETE FROM public.bom_items
  WHERE bom_id = p_bom_id AND component_id = p_component_id;
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- Function: remove_participant
CREATE OR REPLACE FUNCTION public.remove_participant(p_conversation_id uuid, p_user_id uuid)
 RETURNS boolean
 LANGUAGE sql
 SECURITY DEFINER
AS $function$
  delete from public.conversation_participants
  where conversation_id = p_conversation_id and user_id = p_user_id;
  select true;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- Function: remove_participant
CREATE OR REPLACE FUNCTION public.remove_participant(p_conversation_id text, p_user_id text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  DELETE FROM public.conversation_participants
  WHERE conversation_id = p_conversation_id::uuid
    AND user_id = p_user_id::uuid;
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- Function: restock_order
CREATE OR REPLACE FUNCTION public.restock_order(p_order_id text, p_store text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_user_id uuid;
  v_restocked_count integer := 0;
  v_transaction record;
BEGIN
  v_user_id := COALESCE(auth.uid(), '00000000-0000-0000-0000-000000000000'::uuid);
  
  -- Find all deductions for this order and reverse them
  FOR v_transaction IN 
    SELECT component_id, ABS(quantity_change) as qty_to_restore
    FROM public.stock_transactions
    WHERE reference_order_id = p_order_id
      AND transaction_type = 'order_deduction'
  LOOP
    -- Add the stock back
    UPDATE public.components
    SET current_stock = current_stock + v_transaction.qty_to_restore,
        updated_at = now()
    WHERE id = v_transaction.component_id;
    
    -- Log the restock transaction
    INSERT INTO public.stock_transactions (
      component_id, transaction_type, quantity_change,
      quantity_before, quantity_after, reference_order_id,
      reason, performed_by
    )
    SELECT 
      v_transaction.component_id,
      'order_restock',
      v_transaction.qty_to_restore,
      current_stock - v_transaction.qty_to_restore,
      current_stock,
      p_order_id,
      'Order cancelled/returned - restocking components',
      v_user_id
    FROM public.components
    WHERE id = v_transaction.component_id;
    
    v_restocked_count := v_restocked_count + 1;
  END LOOP;
  
  RETURN jsonb_build_object(
    'success', true,
    'order_id', p_order_id,
    'components_restocked', v_restocked_count
  );
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -- Function: rls_bypass
CREATE OR REPLACE FUNCTION public.rls_bypass()
 RETURNS boolean
 LANGUAGE sql
 STABLE
AS $function$
select (not feature_rls_enabled()) or app_is_service_role();
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- Function: send_message
CREATE OR REPLACE FUNCTION public.send_message(p_conversation_id uuid, p_content text)
 RETURNS bigint
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare
  v_me uuid := auth.uid();
  v_id bigint;
  v_name text := public.current_user_name();
begin
  if v_me is null then
    raise exception 'Not authenticated';
  end if;
  if p_content is null or length(btrim(p_content)) = 0 then
    raise exception 'Message body required';
  end if;

  -- only participants can post
  if not exists (
    select 1 from public.conversation_participants p
    where p.conversation_id = p_conversation_id and p.user_id = v_me
  ) then
    raise exception 'Not a participant';
  end if;

  insert into public.messages(conversation_id, sender_id, sender_name, body)
  values (p_conversation_id, v_me, coalesce(v_name, 'Unknown'), p_content)
  returning id into v_id;

  -- mark the sender as read now
  insert into public.message_reads(conversation_id, user_id, last_read_at)
  values (p_conversation_id, v_me, now())
  on conflict (conversation_id, user_id) do update set last_read_at = excluded.last_read_at;

  return v_id;
end;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- Function: set_due_date_settings
CREATE OR REPLACE FUNCTION public.set_due_date_settings(p_store text, p_settings jsonb)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_default_due text;
  v_allowed_days jsonb;
  v_blackout_dates jsonb;
BEGIN
  -- Validate store
  IF p_store NOT IN ('bannos', 'flourlane', 'global') THEN
    RAISE EXCEPTION 'Invalid store: %', p_store;
  END IF;

  -- Validate settings object
  IF p_settings IS NULL THEN
    RAISE EXCEPTION 'Settings object cannot be null';
  END IF;

  -- Extract values from settings object
  v_default_due := p_settings->>'defaultDue';
  v_allowed_days := p_settings->'allowedDays';
  v_blackout_dates := p_settings->'blackoutDates';

  -- Validate required fields
  IF v_default_due IS NULL OR v_default_due = '' THEN
    RAISE EXCEPTION 'defaultDue is required';
  END IF;

  IF v_allowed_days IS NULL OR jsonb_typeof(v_allowed_days) != 'array' THEN
    RAISE EXCEPTION 'allowedDays must be a JSON array';
  END IF;

  IF v_blackout_dates IS NULL OR jsonb_typeof(v_blackout_dates) != 'array' THEN
    RAISE EXCEPTION 'blackoutDates must be a JSON array';
  END IF;

  -- Insert or update settings
  INSERT INTO public.settings (store, key, value)
  VALUES 
    (p_store, 'dueDates.defaultDue', to_jsonb(v_default_due)),
    (p_store, 'dueDates.allowedDays', v_allowed_days),
    (p_store, 'dueDates.blackoutDates', v_blackout_dates)
  ON CONFLICT (store, key) 
  DO UPDATE SET value = EXCLUDED.value, created_at = now();
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- Function: set_flavours
CREATE OR REPLACE FUNCTION public.set_flavours(p_store text, p_flavours text[])
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_flavours_json jsonb;
BEGIN
  -- Validate store
  IF p_store NOT IN ('bannos', 'flourlane', 'global') THEN
    RAISE EXCEPTION 'Invalid store: %', p_store;
  END IF;

  -- Validate flavours array
  IF p_flavours IS NULL OR array_length(p_flavours, 1) = 0 THEN
    RAISE EXCEPTION 'Flavours array cannot be empty';
  END IF;

  -- Convert text array to JSONB array
  v_flavours_json := to_jsonb(p_flavours);

  -- Insert or update flavours in settings table
  INSERT INTO public.settings (store, key, value)
  VALUES (p_store, 'flavours', v_flavours_json)
  ON CONFLICT (store, key) 
  DO UPDATE SET value = v_flavours_json, created_at = now();
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- Function: set_monitor_density
CREATE OR REPLACE FUNCTION public.set_monitor_density(p_store text, p_density text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Validate store
  IF p_store NOT IN ('bannos', 'flourlane', 'global') THEN
    RAISE EXCEPTION 'Invalid store: %', p_store;
  END IF;

  -- Validate density value
  IF p_density NOT IN ('compact', 'cozy') THEN
    RAISE EXCEPTION 'Invalid density value: %. Must be "compact" or "cozy"', p_density;
  END IF;

  -- Insert or update monitor density in settings table
  INSERT INTO public.settings (store, key, value)
  VALUES (p_store, 'monitor.density', to_jsonb(p_density))
  ON CONFLICT (store, key) 
  DO UPDATE SET value = to_jsonb(p_density), created_at = now();
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- Function: set_printing_settings
CREATE OR REPLACE FUNCTION public.set_printing_settings(p_store text, p_settings jsonb)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- For now, just return success
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- Function: set_setting
CREATE OR REPLACE FUNCTION public.set_setting(p_store text, p_key text, p_value jsonb)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Validate store
  IF p_store NOT IN ('bannos', 'flourlane', 'global') THEN
    RAISE EXCEPTION 'Invalid store: %', p_store;
  END IF;

  -- Validate key
  IF p_key IS NULL OR p_key = '' THEN
    RAISE EXCEPTION 'Setting key cannot be empty';
  END IF;

  -- Insert or update setting
  INSERT INTO public.settings (store, key, value)
  VALUES (p_store, p_key, p_value)
  ON CONFLICT (store, key) 
  DO UPDATE SET value = p_value, created_at = now();
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- Function: set_storage_locations
CREATE OR REPLACE FUNCTION public.set_storage_locations(p_store text, p_locations text[])
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_locations_json jsonb;
BEGIN
  -- Validate store
  IF p_store NOT IN ('bannos', 'flourlane', 'global') THEN
    RAISE EXCEPTION 'Invalid store: %', p_store;
  END IF;

  -- Validate locations array
  IF p_locations IS NULL OR array_length(p_locations, 1) = 0 THEN
    RAISE EXCEPTION 'Storage locations array cannot be empty';
  END IF;

  -- Convert text array to JSONB array
  v_locations_json := to_jsonb(p_locations);

  -- Insert or update storage locations in settings table
  INSERT INTO public.settings (store, key, value)
  VALUES (p_store, 'storage_locations', v_locations_json)
  ON CONFLICT (store, key) 
  DO UPDATE SET value = v_locations_json, created_at = now();
  
  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- Function: set_updated_at
CREATE OR REPLACE FUNCTION public.set_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- Function: settings_get_bool
CREATE OR REPLACE FUNCTION public.settings_get_bool(ns text, k text, default_value boolean)
 RETURNS boolean
 LANGUAGE sql
 STABLE
AS $function$
  select coalesce((
    select
      case
        when jsonb_typeof(s.value) = 'boolean' then (s.value)::boolean
        when jsonb_typeof(s.value) is null then default_value
        else
          case
            when lower(trim(both '"' from (s.value)::text)) in ('1','true','yes','on') then true
            else false
          end
      end
    from public.settings s
    where s.store = ns and s.key = k
    limit 1
  ), default_value);
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- Function: start_packing
CREATE OR REPLACE FUNCTION public.start_packing(p_order_id uuid)
 RETURNS orders
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_row public.orders;
begin
  perform public._order_lock(p_order_id);

  update public.orders
     set packing_start_ts = coalesce(packing_start_ts, now()),
         updated_at = now()
   where id = p_order_id
  returning * into v_row;

  insert into public.audit_log(action, performed_by, source, meta)
  values ('start_packing', null, 'rpc', jsonb_build_object('order_id', p_order_id));

  return v_row;
end
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- Function: test_auth
CREATE OR REPLACE FUNCTION public.test_auth()
 RETURNS TABLE(user_id uuid, user_email text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    auth.uid() as user_id,
    auth.email() as user_email;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- Function: test_rpc_call
CREATE OR REPLACE FUNCTION public.test_rpc_call()
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN 'RPC function called successfully at ' || NOW()::text || ' by user ' || COALESCE(auth.uid()::text, 'NULL');
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- Function: update_component_stock
CREATE OR REPLACE FUNCTION public.update_component_stock(p_component_id uuid, p_delta numeric, p_reason text, p_order_id text DEFAULT NULL::text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_old_stock numeric;
  v_new_stock numeric;
  v_user_id uuid;
  v_component_name text;
BEGIN
  -- Get current user (or NULL if not authenticated)
  v_user_id := auth.uid();
  
  -- Get current stock and component name
  SELECT current_stock, name INTO v_old_stock, v_component_name
  FROM public.components 
  WHERE id = p_component_id;
  
  IF v_old_stock IS NULL THEN
    RAISE EXCEPTION 'Component not found: %', p_component_id;
  END IF;
  
  -- Calculate new stock
  v_new_stock := v_old_stock + p_delta;
  
  IF v_new_stock < 0 THEN
    RAISE EXCEPTION 'Insufficient stock. Current: %, Requested: %', v_old_stock, ABS(p_delta);
  END IF;
  
  -- Update component stock
  UPDATE public.components 
  SET 
    current_stock = v_new_stock,
    updated_at = now()
  WHERE id = p_component_id;
  
  -- Log the transaction using the correct audit_log structure
  INSERT INTO public.audit_log (
    action,
    performed_by,
    source,
    meta
  ) VALUES (
    'update_stock',
    v_user_id,  -- This will be NULL if no user is authenticated
    'inventory_system',
    jsonb_build_object(
      'component_id', p_component_id,
      'component_name', v_component_name,
      'old_stock', v_old_stock,
      'new_stock', v_new_stock,
      'delta', p_delta,
      'reason', p_reason,
      'order_id', COALESCE(p_order_id, 'N/A')
    )
  );
  
  -- Return success response
  RETURN jsonb_build_object(
    'success', true,
    'component_id', p_component_id,
    'old_stock', v_old_stock,
    'new_stock', v_new_stock,
    'delta', p_delta
  );
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- Function: update_order_core
CREATE OR REPLACE FUNCTION public.update_order_core(p_order_id text, p_store text, p_customer_name text DEFAULT NULL::text, p_product_title text DEFAULT NULL::text, p_flavour text DEFAULT NULL::text, p_notes text DEFAULT NULL::text, p_due_date date DEFAULT NULL::date, p_delivery_method text DEFAULT NULL::text, p_size text DEFAULT NULL::text, p_item_qty integer DEFAULT NULL::integer, p_storage text DEFAULT NULL::text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_table_name text;
  v_old_values jsonb;
  v_new_values jsonb;
  v_user_id uuid;
  v_update_parts text[] := ARRAY[]::text[];
  v_new_priority smallint;
  v_current_due_date date;
BEGIN
  -- Check if user has permission to update orders
  IF NOT public.check_user_role('Supervisor') THEN
    RAISE EXCEPTION 'Insufficient permissions to update orders';
  END IF;

  -- Validate store
  IF p_store NOT IN ('bannos', 'flourlane') THEN
    RAISE EXCEPTION 'Invalid store: %', p_store;
  END IF;

  -- Get user ID for audit log
  v_user_id := COALESCE(auth.uid(), '00000000-0000-0000-0000-000000000000'::uuid);

  -- Set table name based on store
  v_table_name := 'orders_' || p_store;

  -- Get current values for audit log and due_date
  EXECUTE format('SELECT to_jsonb(o.*), o.due_date FROM public.%I o WHERE o.id = $1', v_table_name)
  USING p_order_id INTO v_old_values, v_current_due_date;

  IF v_old_values IS NULL THEN
    RAISE EXCEPTION 'Order not found: %', p_order_id;
  END IF;

  -- Calculate new priority if due_date is being updated
  IF p_due_date IS NOT NULL THEN
    -- Priority calculation based on due_date (same logic as order_transform.ts)
    -- HIGH: today/overdue/tomorrow (deltaDays <= 1)
    -- MEDIUM: within 3 days (deltaDays <= 3)  
    -- LOW: more than 3 days (deltaDays > 3)
    DECLARE
      v_delta_days integer;
    BEGIN
      v_delta_days := p_due_date - CURRENT_DATE;
      
      IF v_delta_days <= 1 THEN
        v_new_priority := 1; -- HIGH
      ELSIF v_delta_days <= 3 THEN
        v_new_priority := 0; -- MEDIUM
      ELSE
        v_new_priority := -1; -- LOW
      END IF;
    END;
  END IF;

  -- Build dynamic UPDATE statement
  IF p_customer_name IS NOT NULL THEN
    v_update_parts := array_append(v_update_parts, 'customer_name = ' || quote_literal(p_customer_name));
  END IF;

  IF p_product_title IS NOT NULL THEN
    v_update_parts := array_append(v_update_parts, 'product_title = ' || quote_literal(p_product_title));
  END IF;

  IF p_flavour IS NOT NULL THEN
    v_update_parts := array_append(v_update_parts, 'flavour = ' || quote_literal(p_flavour));
  END IF;

  IF p_notes IS NOT NULL THEN
    v_update_parts := array_append(v_update_parts, 'notes = ' || quote_literal(p_notes));
  END IF;

  IF p_due_date IS NOT NULL THEN
    v_update_parts := array_append(v_update_parts, 'due_date = ' || quote_literal(p_due_date));
    -- Update priority when due_date changes
    v_update_parts := array_append(v_update_parts, 'priority = ' || v_new_priority);
  END IF;

  IF p_delivery_method IS NOT NULL THEN
    v_update_parts := array_append(v_update_parts, 'delivery_method = ' || quote_literal(p_delivery_method));
  END IF;

  IF p_size IS NOT NULL THEN
    v_update_parts := array_append(v_update_parts, 'size = ' || quote_literal(p_size));
  END IF;

  IF p_item_qty IS NOT NULL THEN
    v_update_parts := array_append(v_update_parts, 'item_qty = ' || p_item_qty);
  END IF;

  IF p_storage IS NOT NULL THEN
    v_update_parts := array_append(v_update_parts, 'storage = ' || quote_literal(p_storage));
  END IF;

  -- If nothing to update, return early
  IF array_length(v_update_parts, 1) IS NULL THEN
    RETURN false;
  END IF;

  -- Add updated_at
  v_update_parts := array_append(v_update_parts, 'updated_at = now()');

  -- Execute update
  EXECUTE format('UPDATE public.%I SET %s WHERE id = $1', 
    v_table_name, array_to_string(v_update_parts, ', '))
  USING p_order_id;

  -- Get new values for audit log
  EXECUTE format('SELECT to_jsonb(o.*) FROM public.%I o WHERE o.id = $1', v_table_name)
  USING p_order_id INTO v_new_values;

  -- Log the action
  INSERT INTO public.audit_log (
    table_name, record_id, action, old_values, new_values, actor_id, store, order_id
  ) VALUES (
    v_table_name, p_order_id, 'update_order_core',
    v_old_values, v_new_values, v_user_id, p_store, p_order_id
  );

  RETURN true;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- Function: upsert_accessory_keyword
CREATE OR REPLACE FUNCTION public.upsert_accessory_keyword(p_keyword text, p_component_id uuid, p_id uuid DEFAULT NULL::uuid, p_priority integer DEFAULT 0, p_match_type text DEFAULT 'contains'::text, p_is_active boolean DEFAULT true)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_keyword_id uuid;
BEGIN
  IF p_id IS NOT NULL THEN
    -- Update existing keyword
    UPDATE public.accessory_keywords
    SET keyword = p_keyword,
        component_id = p_component_id,
        priority = p_priority,
        match_type = p_match_type,
        is_active = p_is_active,
        updated_at = now()
    WHERE id = p_id
    RETURNING id INTO v_keyword_id;
  ELSE
    -- Create new keyword
    INSERT INTO public.accessory_keywords (keyword, component_id, priority, match_type, is_active)
    VALUES (p_keyword, p_component_id, p_priority, p_match_type, p_is_active)
    RETURNING id INTO v_keyword_id;
  END IF;
  
  RETURN v_keyword_id;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- Function: upsert_bom
CREATE OR REPLACE FUNCTION public.upsert_bom(p_product_title text, p_store text, p_bom_id uuid DEFAULT NULL::uuid, p_description text DEFAULT NULL::text, p_shopify_product_id text DEFAULT NULL::text)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_bom_id uuid;
BEGIN
  IF p_bom_id IS NOT NULL THEN
    -- Update existing BOM
    UPDATE public.boms
    SET product_title = p_product_title,
        store = p_store,
        description = p_description,
        shopify_product_id = p_shopify_product_id,
        updated_at = now()
    WHERE id = p_bom_id
    RETURNING id INTO v_bom_id;
  ELSE
    -- Create new BOM
    INSERT INTO public.boms (product_title, store, description, shopify_product_id)
    VALUES (p_product_title, p_store, p_description, p_shopify_product_id)
    RETURNING id INTO v_bom_id;
  END IF;
  
  RETURN v_bom_id;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- Function: upsert_component
CREATE OR REPLACE FUNCTION public.upsert_component(p_sku text, p_name text, p_id uuid DEFAULT NULL::uuid, p_description text DEFAULT NULL::text, p_category text DEFAULT NULL::text, p_unit text DEFAULT 'each'::text, p_current_stock numeric DEFAULT 0, p_min_stock numeric DEFAULT 0, p_max_stock numeric DEFAULT NULL::numeric, p_cost_per_unit numeric DEFAULT NULL::numeric, p_supplier text DEFAULT NULL::text, p_supplier_sku text DEFAULT NULL::text, p_is_active boolean DEFAULT true)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_component_id uuid;
  v_user_id uuid;
BEGIN
  -- Get user ID for audit log (only if user is authenticated)
  v_user_id := auth.uid();

  -- Upsert component (without is_active column since it doesn't exist in the table)
  INSERT INTO public.components (
    id, sku, name, description, category, unit, 
    current_stock, min_stock, max_stock, cost_per_unit, 
    supplier, supplier_sku
  ) VALUES (
    COALESCE(p_id, gen_random_uuid()),
    p_sku, p_name, p_description, p_category, p_unit,
    p_current_stock, p_min_stock, p_max_stock, p_cost_per_unit,
    p_supplier, p_supplier_sku
  )
  ON CONFLICT (sku) DO UPDATE SET
    name = EXCLUDED.name,
    description = EXCLUDED.description,
    category = EXCLUDED.category,
    unit = EXCLUDED.unit,
    current_stock = EXCLUDED.current_stock,
    min_stock = EXCLUDED.min_stock,
    max_stock = EXCLUDED.max_stock,
    cost_per_unit = EXCLUDED.cost_per_unit,
    supplier = EXCLUDED.supplier,
    supplier_sku = EXCLUDED.supplier_sku,
    updated_at = now()
  RETURNING id INTO v_component_id;

  -- Log the action (only if we have a valid user ID)
  IF v_user_id IS NOT NULL THEN
    INSERT INTO public.audit_log (
      action,
      performed_by,
      source,
      meta
    ) VALUES (
      CASE WHEN p_id IS NOT NULL THEN 'update_component' ELSE 'create_component' END,
      v_user_id,
      'inventory_system',
      jsonb_build_object(
        'component_id', v_component_id,
        'sku', p_sku,
        'name', p_name,
        'category', p_category
      )
    );
  END IF;

  RETURN v_component_id;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- Function: upsert_product_requirement
CREATE OR REPLACE FUNCTION public.upsert_product_requirement(p_shopify_product_id text, p_shopify_variant_id text, p_product_title text, p_component_id uuid, p_quantity_per_unit numeric, p_id uuid DEFAULT NULL::uuid, p_is_optional boolean DEFAULT false, p_auto_deduct boolean DEFAULT true)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_req_id uuid;
BEGIN
  IF p_id IS NOT NULL THEN
    -- Update existing
    UPDATE public.product_requirements
    SET shopify_product_id = p_shopify_product_id,
        shopify_variant_id = p_shopify_variant_id,
        product_title = p_product_title,
        component_id = p_component_id,
        quantity_per_unit = p_quantity_per_unit,
        is_optional = p_is_optional,
        auto_deduct = p_auto_deduct,
        updated_at = now()
    WHERE id = p_id
    RETURNING id INTO v_req_id;
  ELSE
    -- Create new
    INSERT INTO public.product_requirements (
      shopify_product_id, shopify_variant_id, product_title,
      component_id, quantity_per_unit, is_optional, auto_deduct
    )
    VALUES (
      p_shopify_product_id, p_shopify_variant_id, p_product_title,
      p_component_id, p_quantity_per_unit, p_is_optional, p_auto_deduct
    )
    RETURNING id INTO v_req_id;
  END IF;
  
  RETURN v_req_id;
END;
$function$
;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |