
# Webhook Inbox Processor - Final Implementation Plan

## ğŸ¯ What the Liquid Template Shows Us

Your template loops through `line_items` and displays each one. This means:
- **One line_item = One order record in database**
- Multi-cake orders automatically split by processing each line_item

## ğŸ“‹ Data Extraction (Following Liquid Template)

### From Order Level
```javascript
// Top level order data
order_number: payload.name.replace('#', ''),  // "#B24517" â†’ "B24517"
customer_name: payload.shipping_address?.name || 
               `${payload.customer.first_name} ${payload.customer.last_name}`.trim(),
due_date: parseDeliveryDate(payload.note_attributes), // Parse "Sat 8 Nov 2025..."
delivery_method: findNoteAttribute('Delivery Method'), // "pickup" or "delivery"
notes: payload.note,
currency: payload.currency,
total_amount: parseFloat(payload.total_price)
```

### For EACH line_item (Loop)
```javascript
payload.line_items.forEach((line_item, index) => {
  const orderData = {
    // Product info
    product_title: line_item.title,           // "White Personalised Cake"
    
    // Parse variant_title "Medium / Vanilla" â†’ size + flavour
    size: extractSize(line_item.variant_title),      // "Medium"
    flavour: extractFlavour(line_item.variant_title), // "Vanilla"
    
    // Quantity
    item_qty: line_item.quantity,
    
    // Properties (Cake Writing, etc.)
    properties: extractProperties(line_item.properties),
    
    // Generate suffix if multiple items
    suffix: line_items.length > 1 ? String.fromCharCode(65 + index) : null // A, B, C
  };
  
  // Insert into orders_bannos or orders_flourlane
  insertOrder(orderData);
});
```

## ğŸ”§ Implementation Components

### 1. Edge Function: `process-webhook-inbox`

**Location**: `supabase/functions/process-webhook-inbox/index.ts`

**What it does:**
```typescript
1. SELECT unprocessed rows FROM webhook_inbox_bannos (LIMIT 10)
2. FOR EACH row:
   a. Parse payload JSON
   b. FOR EACH line_item:
      - Extract order-level data
      - Extract line_item data
      - Parse variant_title â†’ size + flavour
      - Extract properties (Cake Writing)
      - Call process_inbox_order RPC
   c. Mark row as processed = true
3. Return summary (processed: X, failed: Y)
```

### 2. Database RPC: `process_inbox_order`

**Location**: `supabase/migrations/067_process_inbox_order.sql`

**Signature**:
```sql
CREATE OR REPLACE FUNCTION process_inbox_order(
  p_store text,
  p_order_data jsonb
) RETURNS text
```

**What it does:**
- Receives extracted order data as JSON
- Inserts into orders_bannos or orders_flourlane
- human_id generated by existing trigger
- Returns order ID or error

### 3. Helper Functions (JavaScript)

**In Edge Function:**

```typescript
// Parse "Medium / Vanilla" â†’ {size: "Medium", flavour: "Vanilla"}
function parseVariantTitle(variant: string) {
  const parts = variant.split('/').map(s => s.trim());
  return {
    size: parts[0] || null,
    flavour: parts[1] || null
  };
}

// Parse "Sat 8 Nov 2025 between 8:00 AM and 6:00 PM" â†’ "2025-11-08"
function parseDeliveryDate(noteAttributes) {
  const attr = noteAttributes.find(a => a.name === 'Local Delivery Date and Time');
  if (!attr) return null;
  
  // Extract "Sat 8 Nov 2025"
  const datePart = attr.value.split('between')[0].trim();
  // Parse to YYYY-MM-DD
  return new Date(datePart).toISOString().split('T')[0];
}

// Extract properties (Cake Writing, etc.) into notes
function extractProperties(properties) {
  const filtered = properties.filter(p => 
    !p.name.includes('_origin') &&
    !p.name.includes('_raw') &&
    !p.name.includes('gwp') &&
    !p.name.includes('_LocalDeliveryID') &&
    p.value
  );
  
  return filtered.map(p => `${p.name}: ${p.value}`).join('\n');
}
```

## ğŸ“Š Database Schema Check

**Do we need new columns?**

Current `orders_bannos` / `orders_flourlane` columns:
- âœ… `human_id` - Generated by trigger
- âœ… `shopify_order_number` - Exists
- âœ… `customer_name` - Exists
- âœ… `product_title` - Exists
- âœ… `size` - Exists
- âœ… `flavour` - Exists
- âœ… `item_qty` - Exists
- âœ… `due_date` - Exists
- âœ… `delivery_method` - Exists
- âœ… `notes` - Exists (can store properties here)
- âœ… `currency` - Exists
- âœ… `total_amount` - Exists

**We're good!** No migration needed - all columns exist.

## ğŸ¯ Processing Flow

```
1. Webhook arrives â†’ webhook_inbox (processed=false)
2. [Manual/Cron] Trigger processor
3. Edge Function reads unprocessed rows
4. FOR EACH line_item:
   - Extract data following Liquid template logic
   - Call process_inbox_order RPC
   - Creates order with human_id from trigger
5. Mark inbox row processed=true
6. Orders appear in UI with all data âœ…
```

## â“ Remaining Questions

1. **Properties (Cake Writing, etc.):**
   - Store in `notes` field as text?
   - Or create separate `accessories` column (JSONB)?

2. **Suffix for split orders:**
   - If order has 2 line_items, create:
     - `bannos-24517-A` (first cake)
     - `bannos-24517-B` (second cake)
   - How does the trigger know to add suffix?

3. **Trigger Button Location:**
   - Settings page â†’ "Process Inbox" button?
   - Shows count of unprocessed orders?

4. **Error Handling:**
   - If one line_item fails, continue with others?
   - Or fail entire order?

Please clarify these 4 points and I'll have everything needed!

